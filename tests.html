<meta charset="utf-8">
<link rel="stylesheet" href="./test-micro-framework/test-micro-framework.css">

<script type="module">
  import { it, assertEqual } from "./test-micro-framework/test-micro-framework.js"
  import { pluralise, parseResults, mergeCounts, generateAltText } from "./src/generate-alt.js";
  import { ResultLine } from "./src/ResultLine.js";

  // -------------------
  // Pluralise
  // -------------------

  it("pluralise: pluralises when count is 0", () => {
    assertEqual(
      pluralise(0, "eddie"),
      "eddies"
    );
  });

  it("pluralise: pluralises when count is negative", () => {
    assertEqual(
      pluralise(-20, "eddie"),
      "eddies"
    );
  });

  it("pluralise: pluralises when count is positive", () => {
    assertEqual(
      pluralise(20, "eddie"),
      "eddies"
    );
  });

  it("pluralise: does not pluralise when count is 1", () => {
    assertEqual(
      pluralise(1, "eddie"),
      "eddie"
    );
  });

  // -------------------
  // parseResults
  // -------------------

  it("parseResults: works with missing keys", () => {
    const testResults = { correct: 2 }

    assertEqual(
      parseResults(testResults),
      "2 correct guesses."
    );
  });

  it("parseResults: ignores invalid keys", () => {
    const testResults = { correct: 5, faker: 100, hint: 5 }

    assertEqual(
      parseResults(testResults),
      "5 correct guesses. 5 hints."
    );
  })

  it("parseResults: correctly orders output with a mix of all valid keys", () => {
    const testResults = { doubleHint: 10, correct: 4, mistake: 1, hint: 5 }

    assertEqual(
      parseResults(testResults),
      "4 correct guesses. 1 mistake. 5 hints. 10 double hints."
    );
  })

  it("parseResults: renders a nicer message when all are correct", () => {
    const testResults = { correct: 20 }

    assertEqual(
      parseResults(testResults),
      "Clean sweep! All correct with no mistakes or hints."
    );
  })

  // -------------------
  // mergeCounts
  // -------------------

  it("mergeCounts: instantiates items missing in accumulator", () => {
    const resultTotals = {}
    const testResultLine = new ResultLine("ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ¨");

    assertEqual(
      mergeCounts(resultTotals, testResultLine.counts()),
      { correct: 3, mistake: 1 }
    );
  })

  it("mergeCounts: ignores invalid keys", () => {
    const resultTotals = {}
    const testResultLine = new ResultLine("ğŸŸ©ğŸ‘ï¸ğŸŸ©ğŸŸ¨")

    assertEqual(
      mergeCounts(resultTotals, testResultLine.counts()),
      { correct: 2, mistake: 1 }
    );
  })

  it("mergeCounts: does not modify the existing object", () => {
    const resultTotals = { correct: 8, hint: 2, doubleHint: 5, mistake: 1 }
    const testResultLine = new ResultLine("ğŸŸ©ğŸŸ¨ğŸŸ¡ğŸŸ ")

    const updatedTotals = mergeCounts(resultTotals, testResultLine.counts());

    assertEqual(
      resultTotals,
      { correct: 8, hint: 2, doubleHint: 5, mistake: 1 }
    );

    assertEqual(
      updatedTotals,
      { correct: 9, hint: 3, doubleHint: 6, mistake: 2 }
    );
  })

  it("mergeCounts: returns modified object", () => {
    const resultTotals = { correct: 8, hint: 2, doubleHint: 5, mistake: 1 }
    const testResultLine = new ResultLine("ğŸŸ©ğŸŸ¨ğŸŸ¡ğŸŸ ")

    assertEqual(
      mergeCounts(resultTotals, testResultLine.counts()),
      { correct: 9, hint: 3, doubleHint: 6, mistake: 2 }
    );
  })

  // -------------------
  // generateAltText
  // -------------------

  it("generateAltText: preserves unrecognised lines", () => {
    const testResults = "hi i'm eddie";

    assertEqual(
      generateAltText(testResults),
      "\nhi i'm eddie"
    );
  })

  it("generateAltText: returns preamble & link", () => {
    const testResults = "I solved the daily Clues by Sam, Jan 1st 1970 (Evil), in 00:00\nhttps://cluesbysam.com";

    assertEqual(
      generateAltText(testResults),
      "I solved the daily Clues by Sam, Jan 1st 1970 (Evil), in 00:00\n\nhttps://cluesbysam.com"
    );
  })

  it("generateAltText: supports variations in preamble format", () => {
    const testResults = "I solved the daily Clues by Sam (Jan 1st 1970) in less than 20 minutes\nhttps://cluesbysam.com";

    assertEqual(
      generateAltText(testResults),
      "I solved the daily Clues by Sam (Jan 1st 1970) in less than 20 minutes\n\nhttps://cluesbysam.com"
    );
  })

  it("generateAltText: accumulates multiple rows of results", () => {
    const testResults = "I solved the daily Clues by Sam, (Jan 1st 1970) in less than 20 minutes\nğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©\nğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©\nğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ¨\nğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©\nğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©\nhttps://cluesbysam.com";

    assertEqual(
      generateAltText(testResults),
      "I solved the daily Clues by Sam, (Jan 1st 1970) in less than 20 minutes\n19 correct guesses. 1 mistake.\nhttps://cluesbysam.com"
    );
  })

  it("generateAltText: works with unknown strings & complex results", () => {
    const testResults = "I solved the daily Clues by Sam, (Jan 1st 1970) in less than 20 minutes\nğŸŸ©ğŸŸ¨ğŸŸ¡ğŸŸ \nğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©\nğŸŸ©ğŸŸ¡ğŸŸ©ğŸŸ¨\nğŸŸ©ğŸŸ ğŸŸ¨ğŸŸ©\nğŸŸ©ğŸŸ¡ğŸŸ©ğŸŸ¨\nhttps://cluesbysam.com\nOh my god I did so badly ;-;";

    assertEqual(
      generateAltText(testResults),
      "I solved the daily Clues by Sam, (Jan 1st 1970) in less than 20 minutes\n11 correct guesses. 4 mistakes. 3 hints. 2 double hints.\nhttps://cluesbysam.com\nOh my god I did so badly ;-;"
    );
  })
</script>

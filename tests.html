<meta charset="utf-8">
<meta name="robots" content="noindex, nofollow" />

<link rel="stylesheet" href="./test-micro-framework/test-micro-framework.css">

<script type="module">
  import { it, assertEqual } from "./test-micro-framework/test-micro-framework.js"
  import { pluralise, parseResults, mergeCounts, generateAltText } from "./src/generate-alt.js";
  import { ResultLine } from "./src/ResultLine.js";

  // -------------------
  // Pluralise
  // -------------------

  it("pluralise: pluralises when count is 0", () => {
    assertEqual(
      pluralise(0, "eddie"),
      "eddies"
    );
  });

  it("pluralise: pluralises when count is negative", () => {
    assertEqual(
      pluralise(-20, "eddie"),
      "eddies"
    );
  });

  it("pluralise: pluralises when count is positive", () => {
    assertEqual(
      pluralise(20, "eddie"),
      "eddies"
    );
  });

  it("pluralise: does not pluralise when count is 1", () => {
    assertEqual(
      pluralise(1, "eddie"),
      "eddie"
    );
  });

  // -------------------
  // parseResults
  // -------------------

  it("parseResults: works with missing keys", () => {
    const testResults = { correct: 2 }

    assertEqual(
      parseResults(testResults),
      "2 correct guesses."
    );
  });

  it("parseResults: ignores invalid keys", () => {
    const testResults = { correct: 5, faker: 100, hint: 5 }

    assertEqual(
      parseResults(testResults),
      "5 correct guesses. 5 hints."
    );
  })

  it("parseResults: correctly orders output with a mix of all valid keys", () => {
    const testResults = { doubleHint: 10, correct: 4, mistake: 1, hint: 5 }

    assertEqual(
      parseResults(testResults),
      "4 correct guesses. 1 mistake. 5 hints. 10 double hints."
    );
  })

  it("parseResults: renders a nicer message when all are correct", () => {
    const testResults = { correct: 20 }

    assertEqual(
      parseResults(testResults),
      "Clean sweep! All correct with no mistakes or hints."
    );
  })

  // -------------------
  // mergeCounts
  // -------------------

  it("mergeCounts: instantiates items missing in accumulator", () => {
    const resultTotals = {}
    const testResultLine = new ResultLine("ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ¨");

    assertEqual(
      mergeCounts(resultTotals, testResultLine.counts()),
      { correct: 3, mistake: 1 }
    );
  })

  it("mergeCounts: does not match unknown strings", () => {
    const resultTotals = {}
    const testResultLine = new ResultLine(":large_green_square::eye::large_green_square::large_yellow_square:")

    assertEqual(
      mergeCounts(resultTotals, testResultLine.counts()),
      { correct: 2, mistake: 1 }
    );
  });

  it("mergeCounts: ignores invalid keys", () => {
    const resultTotals = {}
    const testResultLine = new ResultLine("ðŸŸ©ðŸ‘ï¸ðŸŸ©ðŸŸ¨")

    assertEqual(
      mergeCounts(resultTotals, testResultLine.counts()),
      { correct: 2, mistake: 1 }
    );
  })

  it("mergeCounts: does not modify the existing object", () => {
    const resultTotals = { correct: 8, hint: 2, doubleHint: 5, mistake: 1 }
    const testResultLine = new ResultLine("ðŸŸ©ðŸŸ¨ðŸŸ¡ðŸŸ ")

    const updatedTotals = mergeCounts(resultTotals, testResultLine.counts());

    assertEqual(
      resultTotals,
      { correct: 8, hint: 2, doubleHint: 5, mistake: 1 }
    );

    assertEqual(
      updatedTotals,
      { correct: 9, hint: 3, doubleHint: 6, mistake: 2 }
    );
  })

  it("mergeCounts: returns modified object", () => {
    const resultTotals = { correct: 8, hint: 2, doubleHint: 5, mistake: 1 }
    const testResultLine = new ResultLine("ðŸŸ©ðŸŸ¨ðŸŸ¡ðŸŸ ")

    assertEqual(
      mergeCounts(resultTotals, testResultLine.counts()),
      { correct: 9, hint: 3, doubleHint: 6, mistake: 2 }
    );
  })

  it("mergeCounts: recognises string variants of emojis", () => {
    const resultTotals = { correct: 1, hint: 2, doubleHint: 3, mistake: 4 }
    const testResultLine = new ResultLine(":large_green_square::large_yellow_square::large_yellow_circle::large_orange_circle:")

    assertEqual(
      mergeCounts(resultTotals, testResultLine.counts()),
      { correct: 2, hint: 3, doubleHint: 4, mistake: 5 }
    );
  });

  // -------------------
  // generateAltText
  // -------------------

  // From consts.js
  const FRIENDLY_LINE_BREAK = "  \n";

  const STANDARD_LINK_PARTS = ["\nQuick Links:", "Clues By Sam: https://cluesbysam.com", "Alt For Sam: https://altforsam.delete44.com"]

  it("generateAltText: always injects links to resources", () => {
    const testResults = "";
    const expectedParts = STANDARD_LINK_PARTS;

    assertEqual(
      generateAltText(testResults),
      expectedParts.join(FRIENDLY_LINE_BREAK)
    );
  })

  it("generateAltText: ignores many copies of ignored lines", () => {
    const testResults = "https://cluesbysam.com\n"
      + "https://cluesbysam.com\n"
      + "https://cluesbysam.com\n"
      + "https://altforsam.delete44.com\n"
      + "https://altforsam.delete44.com\n"
      + "https://altforsam.delete44.com";

    const expectedParts = STANDARD_LINK_PARTS

    assertEqual(
      generateAltText(testResults),
      expectedParts.join(FRIENDLY_LINE_BREAK)
    );
  })

  it("generateAltText: preserves unrecognised lines", () => {
    const testResults = "hi i'm eddie";
    const expectedParts = ["hi i'm eddie", ...STANDARD_LINK_PARTS]

    assertEqual(
      generateAltText(testResults),
      expectedParts.join(FRIENDLY_LINE_BREAK)
    );
  })

  it("generateAltText: returns preamble & link", () => {
    const testResults = "I solved the daily Clues by Sam, Jan 1st 1970 (Evil), in 00:00\nhttps://cluesbysam.com";
    const expectedParts = ["I solved the daily Clues by Sam, Jan 1st 1970 (Evil), in 00:00", ...STANDARD_LINK_PARTS]

    assertEqual(
      generateAltText(testResults),
      expectedParts.join(FRIENDLY_LINE_BREAK)
    );
  })

  it("generateAltText: supports variations in preamble format", () => {
    let testResults = "I solved the daily Clues by Sam (Jan 1st 1970) in less than 20 minutes\nhttps://cluesbysam.com";
    let expectedParts = ["I solved the daily Clues by Sam (Jan 1st 1970) in less than 20 minutes", ...STANDARD_LINK_PARTS]

    assertEqual(
      generateAltText(testResults),
      expectedParts.join(FRIENDLY_LINE_BREAK)
    );

    testResults = "Clues by Sam - Jan 1st 1970\n(Medium)\nLess than 12 minutes\nhttps://cluesbysam.com";
    expectedParts = ["Clues by Sam - Jan 1st 1970", "(Medium)", "Less than 12 minutes", ...STANDARD_LINK_PARTS]

    assertEqual(
      generateAltText(testResults),
      expectedParts.join(FRIENDLY_LINE_BREAK)
    );

    testResults = "#CluesBySam - Jan 19th 2026(Easy)\n(Medium)\nLess than 12 minutes\nhttps://cluesbysam.com";
    expectedParts = ["#CluesBySam - Jan 19th 2026(Easy)", "(Medium)", "Less than 12 minutes", ...STANDARD_LINK_PARTS]

    assertEqual(
      generateAltText(testResults),
      expectedParts.join(FRIENDLY_LINE_BREAK)
    );
  })

  it("generateAltText: supports variations in preamble format: supports I Solved... preamble", () => {
    const testResults = "I solved the daily Clues by Sam (Jan 1st 1970) in less than 20 minutes\nhttps://cluesbysam.com";
    const expectedParts = ["I solved the daily Clues by Sam (Jan 1st 1970) in less than 20 minutes", ...STANDARD_LINK_PARTS]

    assertEqual(
      generateAltText(testResults),
      expectedParts.join(FRIENDLY_LINE_BREAK)
    );
  })

  it("generateAltText: supports variations in preamble format: Supports hashtags", () => {
    const testResults = "I solved the daily #CluesBySam (Jan 1st 1970) in less than 20 minutes\nhttps://cluesbysam.com";
    const expectedParts = ["I solved the daily #CluesBySam (Jan 1st 1970) in less than 20 minutes", ...STANDARD_LINK_PARTS]

    assertEqual(
      generateAltText(testResults),
      expectedParts.join(FRIENDLY_LINE_BREAK)
    );
  })

  it("generateAltText: supports variations in preamble format: Supports Clues by Sam... preamble", () => {
    const testResults = "Clues by Sam - Jan 1st 1970\n(Medium)\nLess than 12 minutes\nhttps://cluesbysam.com";
    const expectedParts = ["Clues by Sam - Jan 1st 1970", "(Medium)", "Less than 12 minutes", ...STANDARD_LINK_PARTS]

    assertEqual(
      generateAltText(testResults),
      expectedParts.join(FRIENDLY_LINE_BREAK)
    );
  })

  it("generateAltText: supports variations in preamble format: Supports hashtag", () => {
    const testResults = "#CluesBySam - Jan 19th 2026(Easy)\n(Medium)\nLess than 12 minutes\nhttps://cluesbysam.com";
    const expectedParts = ["#CluesBySam - Jan 19th 2026(Easy)", "(Medium)", "Less than 12 minutes", ...STANDARD_LINK_PARTS]

    assertEqual(
      generateAltText(testResults),
      expectedParts.join(FRIENDLY_LINE_BREAK)
    );
  })

  it("generateAltText: accumulates multiple rows of results", () => {
    const testResults = "I solved the daily Clues by Sam, (Jan 1st 1970) in less than 20 minutes\nðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©\nðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©\nðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ¨\nðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©\nðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©\nhttps://cluesbysam.com";
    const expectedParts = ["I solved the daily Clues by Sam, (Jan 1st 1970) in less than 20 minutes",
      "19 correct guesses. 1 mistake.",
      ...STANDARD_LINK_PARTS,
      "\nFull Results:",
      "ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©",
      "ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©",
      "ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ¨",
      "ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©",
      "ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©"]

    assertEqual(
      generateAltText(testResults),
      expectedParts.join(FRIENDLY_LINE_BREAK)
    );
  })

  it("generateAltText: works with unknown strings & complex results", () => {
    const testResults = "I solved the daily Clues by Sam, (Jan 1st 1970) in less than 20 minutes\nðŸŸ©ðŸŸ¨ðŸŸ¡ðŸŸ \nðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©\nðŸŸ©ðŸŸ¡ðŸŸ©ðŸŸ¨\nðŸŸ©ðŸŸ ðŸŸ¨ðŸŸ©\nðŸŸ©ðŸŸ¡ðŸŸ©ðŸŸ¨\nOh my god I did so badly ;-;\nhttps://cluesbysam.com";
    const expectedParts = ["I solved the daily Clues by Sam, (Jan 1st 1970) in less than 20 minutes",
      "11 correct guesses. 4 mistakes. 3 hints. 2 double hints.",
      "Oh my god I did so badly ;-;",
      ...STANDARD_LINK_PARTS,
      "\nFull Results:",
      "ðŸŸ©ðŸŸ¨ðŸŸ¡ðŸŸ ",
      "ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©",
      "ðŸŸ©ðŸŸ¡ðŸŸ©ðŸŸ¨",
      "ðŸŸ©ðŸŸ ðŸŸ¨ðŸŸ©",
      "ðŸŸ©ðŸŸ¡ðŸŸ©ðŸŸ¨"]

    assertEqual(
      generateAltText(testResults),
      expectedParts.join(FRIENDLY_LINE_BREAK)
    );
  })

  it("generateAltText: matches string emojis in complex results", () => {
    const testResults = "I solved the daily Clues by Sam, Jan 1st 1970 (Medium), in less than 20 minutes\n"
      + ":large_yellow_circle::large_green_square::large_green_square::large_yellow_square:\n"
      + ":large_green_square::large_green_square::large_green_square::large_green_square:\n"
      + ":large_green_square::large_green_square::large_green_square::large_green_square:\n"
      + ":large_green_square::large_green_square::large_green_square::large_yellow_square:\n"
      + ":large_green_square::large_green_square::large_orange_circle::large_green_square:\n"
      + "https://cluesbysam.com"

    const expectedParts = ["I solved the daily Clues by Sam, Jan 1st 1970 (Medium), in less than 20 minutes",
      "16 correct guesses. 2 mistakes. 1 hint. 1 double hint.",
      ...STANDARD_LINK_PARTS,
      "\nFull Results:",
      ":large_yellow_circle::large_green_square::large_green_square::large_yellow_square:",
      ":large_green_square::large_green_square::large_green_square::large_green_square:",
      ":large_green_square::large_green_square::large_green_square::large_green_square:",
      ":large_green_square::large_green_square::large_green_square::large_yellow_square:",
      ":large_green_square::large_green_square::large_orange_circle::large_green_square:"]

    assertEqual(
      generateAltText(testResults),
      expectedParts.join(FRIENDLY_LINE_BREAK)
    );
  })
</script>
